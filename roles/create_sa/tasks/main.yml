---
- set_fact:
    service_account_name: "{{ project_id }}-sa"

- set_fact:
    service_account: "{{ service_account_name }}@{{ project_id }}.iam.gserviceaccount.com"

- name: check service account exists
  command: >
    gcloud iam service-accounts describe {{ service_account }}
  register: describe_result

- name: create service account
  command: >
    gcloud iam service-accounts create {{ service_account_name }} \
    --display-name={{ service_account_name }}
  when: describe_result.rc > 0

- name: grant roles
  command: >
    gcloud projects add-iam-policy-binding {{ project_id }} \
    --member serviceAccount:{{ service_account }} \
    --role=roles/{{ item }}
  loop:
    - editor

- name: create service account key
  command: >
    gcloud iam service-accounts keys create {{ service_account_key_path }} \
    --iam-account {{ service_account }}
